#cloud-config
#######################################
# Ubuntu 24.04 LTS Cloud-Init Configuration
# Pulls setup scripts from Git repository and executes them
#######################################

#######################################
# CONFIGURATION - Customize these values!
#######################################
# GIT_REPO_URL: Your repository containing the Coolify setup files
# GIT_BRANCH: Branch to clone (default: main)
# See write_files section for server.conf settings

#######################################
# Basic Settings
#######################################
hostname: coolify-server
manage_etc_hosts: true
locale: de_DE.UTF-8
timezone: Europe/Berlin

#######################################
# Users
#######################################
users:
  - default
  - name: deploy
    groups: [sudo, docker]
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_authorized_keys:
      # Add your SSH public key here
      # - ssh-ed25519 AAAAC3... user@host

#######################################
# SSH Configuration
#######################################
ssh_pwauth: false
disable_root: false

#######################################
# Package Management
#######################################
package_update: true
package_upgrade: true
package_reboot_if_required: false

packages:
  - git
  - curl
  - ca-certificates

#######################################
# Write Files
#######################################
write_files:
  # Server configuration - Customize for your server!
  - path: /opt/coolify-bootstrap/server.conf
    owner: root:root
    permissions: '0644'
    content: |
      #######################################
      # Server Configuration
      # Generated by cloud-init
      #######################################

      HOSTNAME="coolify-server"
      LOCALE="de_DE.UTF-8"
      TIMEZONE="UTC"

      NTP_SERVERS="time.bauer-group.com 0.de.pool.ntp.org 1.de.pool.ntp.org 2.de.pool.ntp.org 3.de.pool.ntp.org"
      NTP_FALLBACK="ptbtime1.ptb.de ptbtime2.ptb.de ptbtime3.ptb.de"

      # Network Configuration
      # Leave empty to use DHCP
      # For static IP, fill in all values

      NETWORK_MAC=""
      NETWORK_IPV4=""
      NETWORK_IPV4_NETMASK=""
      NETWORK_IPV4_GATEWAY=""

      # IPv6: Space-separated for multiple addresses
      # Example: "2a0a:4cc0:c2:17d6::1/64 2a0a:4cc0:c2:17d6::2/64"
      NETWORK_IPV6=""
      NETWORK_IPV6_GATEWAY="fe80::1"

      #######################################
      # Example netcup configuration:
      #######################################
      # NETWORK_MAC="0a:e7:f9:c2:a8:59"
      # NETWORK_IPV4="159.195.67.101"
      # NETWORK_IPV4_NETMASK="22"
      # NETWORK_IPV4_GATEWAY="159.195.64.1"
      # NETWORK_IPV6="2a0a:4cc0:c2:17d6::1/64 2a0a:4cc0:c2:17d6::2/64"
      # NETWORK_IPV6_GATEWAY="fe80::1"

  # Bootstrap script - clones repo and runs setup
  - path: /opt/coolify-bootstrap/bootstrap.sh
    owner: root:root
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e

      #######################################
      # Configuration - Set your Git repo here!
      #######################################
      GIT_REPO_URL="${GIT_REPO_URL:-https://github.com/YOUR_USER/YOUR_REPO.git}"
      GIT_BRANCH="${GIT_BRANCH:-main}"
      INSTALL_DIR="/opt/coolify"
      BOOTSTRAP_DIR="/opt/coolify-bootstrap"

      echo ""
      echo "========================================"
      echo " Coolify Server Bootstrap"
      echo "========================================"
      echo ""
      echo "Repository: $GIT_REPO_URL"
      echo "Branch:     $GIT_BRANCH"
      echo ""

      # Clone repository
      echo "[1/4] Cloning repository..."
      if [ -d "$INSTALL_DIR" ]; then
          rm -rf "$INSTALL_DIR"
      fi
      git clone --depth 1 --branch "$GIT_BRANCH" "$GIT_REPO_URL" "$INSTALL_DIR"
      echo "      Done."

      # Copy server.conf to server-setup directory
      echo "[2/4] Copying configuration..."
      if [ -f "$BOOTSTRAP_DIR/server.conf" ]; then
          cp "$BOOTSTRAP_DIR/server.conf" "$INSTALL_DIR/server-setup/server.conf"
          echo "      Configuration copied to $INSTALL_DIR/server-setup/server.conf"
      else
          echo "      Warning: No server.conf found, using defaults"
      fi

      # Make scripts executable
      echo "[3/4] Setting permissions..."
      find "$INSTALL_DIR" -name "*.sh" -exec chmod +x {} \;
      echo "      Done."

      # Run server setup scripts
      echo "[4/4] Running server setup..."
      echo ""
      cd "$INSTALL_DIR/server-setup"

      # Source configuration
      if [ -f server.conf ]; then
          source server.conf
      fi

      # Export all variables for subscripts
      export HOSTNAME LOCALE TIMEZONE
      export NTP_SERVERS NTP_FALLBACK
      export NETWORK_MAC NETWORK_IPV4 NETWORK_IPV4_NETMASK NETWORK_IPV4_GATEWAY
      export NETWORK_IPV6 NETWORK_IPV6_GATEWAY

      # Set hostname
      hostnamectl set-hostname "$HOSTNAME"

      # Run setup scripts in order
      bash 01-system.sh
      bash 02-network.sh
      bash 03-docker.sh

      echo ""
      echo "========================================"
      echo " Bootstrap Complete"
      echo "========================================"
      echo ""
      echo "Server will reboot to apply all changes."
      echo ""
      echo "After reboot, run:"
      echo "  cd /opt/coolify && sudo ./setup.sh"
      echo "  sudo ./coolify.sh start"
      echo ""

#######################################
# Run Commands
#######################################
runcmd:
  # Create bootstrap directory
  - mkdir -p /opt/coolify-bootstrap

  # Set Git repository URL - CUSTOMIZE THIS!
  # Uncomment and set your repository:
  # - export GIT_REPO_URL="https://github.com/YOUR_USER/YOUR_REPO.git"
  # - export GIT_BRANCH="main"

  # Run bootstrap script
  - /opt/coolify-bootstrap/bootstrap.sh

  # Log completion
  - echo "Cloud-Init bootstrap completed at $(date)" >> /var/log/cloud-init-complete.log

#######################################
# Final Message
#######################################
final_message: |
  Cloud-Init configuration complete!

  The server setup scripts have been executed from the Git repository.
  Server will reboot to apply all changes.

  After reboot:
    1. SSH into the server
    2. Run: cd /opt/coolify && sudo ./setup.sh
    3. Run: sudo ./coolify.sh start

  Cloud-Init completed in $UPTIME seconds.

#######################################
# Power State
#######################################
power_state:
  delay: now
  mode: reboot
  message: "Rebooting to apply all configuration changes..."
  timeout: 30
  condition: true
